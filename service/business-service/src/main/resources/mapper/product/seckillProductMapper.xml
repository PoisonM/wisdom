<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wisdom.business.mapper.product.SeckillProductMapper">

	<resultMap id="SeckillProductResultMap" type="com.wisdom.common.dto.product.SeckillProductDTO" >
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="fieldId" property="fieldId" jdbcType="INTEGER" />
		<result column="name" property="productName" jdbcType="VARCHAR" />
		<result column="product_id" property="productId" jdbcType="VARCHAR" />
		<result column="description" property="description" jdbcType="VARCHAR" />
		<result column="first_url" property="firstUrl" jdbcType="VARCHAR" />
		<result column="price" property="price" jdbcType="REAL" />
		<result column="favorable_price" property="favorablePrice" jdbcType="REAL" />
		<result column="product_amount" property="productAmount" jdbcType="INTEGER" />
		<result column="activity_num" property="activityNum" jdbcType="INTEGER" />
		<result column="product_num" property="productNum" jdbcType="INTEGER" />
		<result column="start_time" property="startTime" jdbcType="TIMESTAMP" />
		<result column="end_time" property="endTime" jdbcType="TIMESTAMP" />
		<result column="type" property="productType" jdbcType="TIMESTAMP" />
	</resultMap>


	<!--查询所有商品-->
	<select id="queryAllProducts" resultMap="SeckillProductResultMap"
			resultType="com.wisdom.common.persistence.Page">
		SELECT
		sa.id,ncs.id fieldId,sa.product_id,bp.`name`,bp.first_url,bp.price,sa.favorable_Price,
		sa.product_num,ncs.start_time,ncs.end_time,sa.activity_num,bp.description,ncs.product_amount,bp.type
		from seckill_activity sa
		left join
		(SELECT * FROM (select * from seckill_activity_field
		where  ( now() &gt;= start_time and  end_time &gt;= now()) or start_time &gt;= now()
		ORDER BY start_time DESC) d GROUP BY activity_id ORDER BY start_time DESC
		) ncs
		on sa.id = ncs.activity_id
		LEFT JOIN business_product bp on sa.product_id = bp.product_id
		order by ncs.create_time desc
	</select>

	<!--查询活动列表-->
	<select id="findSeckillActivityList" parameterType="com.wisdom.common.dto.product.SeckillActivityDTO"
			resultType="com.wisdom.common.dto.product.SeckillActivityDTO">
		SELECT
			sa.id,
			sa.activity_no,
			sa.activity_name,
			sa.product_id,
			sa.start_time,
			sa.end_time,
			sa.favorable_price,
			sa.activity_num,
			sa.product_num,
			sa.is_enable
		FROM
			seckill_activity sa
		<where>
			<if test="activityNo!=null and activityNo!=''">
				sa.activity_no LIKE concat('%',concat(#{activityNo},'%'))
			</if>
			<if test="startTime !=null and startTime!=''">
				AND sa.start_time >= startTime
			</if>
			<if test="endTime !=null and endTime!=''">
				AND sa.end_time &lt;= endTime
			</if>
		</where>
		ORDER BY sa.create_time
		limit #{pageNo},#{pageSize}
	</select>

	<!--查询活动列表-->
	<select id="findSeckillActivityCount" parameterType="com.wisdom.common.dto.product.SeckillActivityDTO"
			resultType="com.wisdom.common.dto.product.SeckillActivityDTO">
		SELECT
		 count(1)
		FROM
		seckill_activity sa
		<where>
			<if test="activityNo!=null and activityNo!=''">
				sa.activity_no LIKE concat('%',concat(#{activityNo},'%'))
			</if>
			<if test="startTime !=null and startTime!=''">
				AND sa.start_time >= startTime
			</if>
			<if test="endTime !=null and endTime!=''">
				AND sa.end_time &lt;= endTime
			</if>
		</where>
		ORDER BY sa.create_time
	</select>

	<!--查询所有商品-->
	<select id="findSeckillProductInfoById" resultMap="SeckillProductResultMap">
		SELECT
		sa.id,ncs.id fieldId,sa.product_id,bp.`name`,bp.first_url,bp.price,sa.favorable_Price,
		sa.product_num,ncs.start_time,ncs.end_time,sa.activity_num,bp.description,ncs.product_amount,bp.type
		from seckill_activity sa
		left join
		(SELECT * FROM (select * from seckill_activity_field
		where  ( now() &gt;= start_time and  end_time &gt;= now()) or start_time &gt;= now()
		ORDER BY start_time DESC) d GROUP BY activity_id ORDER BY start_time DESC
		) ncs
		on sa.id = ncs.activity_id
		LEFT JOIN business_product bp on sa.product_id = bp.product_id
		<where>
			<if test="id!=null and id!=''">
				sa.id = #{id}
			</if>
		</where>
	</select>

</mapper>